<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Allenamento">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">
  <title>Allenamento</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      overflow: hidden;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .screen {
      display: none;
      height: 100vh;
      flex-direction: column;
    }
    
    .screen.active {
      display: flex;
    }
    
    /* Setup Screen */
    .setup-screen {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    
    .setup-box {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 2rem;
      padding: 2.5rem;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .setup-title {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .setup-title h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: #333;
    }
    
    .setup-title p {
      color: #666;
      font-size: 1rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 1rem;
      font-size: 1rem;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .setup-btn, .primary-btn {
      width: 100%;
      padding: 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .setup-btn:active, .primary-btn:active {
      transform: scale(0.98);
    }
    
    .setup-btn:disabled, .primary-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .secondary-btn {
      width: 100%;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      border-radius: 1rem;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    
    .danger-btn {
      background: rgba(239, 68, 68, 0.9);
      color: white;
    }
    
    /* Home Screen */
    .home-screen {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      justify-content: center;
      align-items: center;
      padding: 2rem;
    }
    
    .home-title {
      text-align: center;
      color: white;
      margin-bottom: 2rem;
    }
    
    .home-title h1 {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
    }
    
    .user-badge {
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.4);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 0.2rem;
      color: white;
    }
    
    .user-trainer {
      font-size: 0.85rem;
      opacity: 0.8;
      color: white;
    }
    
    .change-user-btn {
      background: rgba(255, 255, 255, 0.3);
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
    }
    
    .day-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
      max-width: 400px;
    }
    
    .day-btn {
      background: rgba(255, 255, 255, 0.35);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-radius: 1.5rem;
      padding: 2rem;
      color: #1a1a2e;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      position: relative;
    }
    
    .day-btn:active {
      transform: scale(0.95);
      background: rgba(255, 255, 255, 0.45);
    }
    
    .day-edit-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(59, 130, 246, 0.8);
      border: none;
      border-radius: 0.5rem;
      padding: 0.4rem 0.8rem;
      color: white;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .day-name {
      font-size: 3rem;
      font-weight: 900;
      margin-bottom: 0.5rem;
    }
    
    .day-count {
      font-size: 1rem;
      opacity: 0.8;
    }
    
    /* Exercise Screen */
    .exercise-screen {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    
    .top-bar {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .home-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 0.5rem;
      padding: 0.5rem;
      color: white;
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    .top-info {
      text-align: center;
      flex: 1;
      color: white;
    }
    
    .top-day {
      font-weight: bold;
      font-size: 1.1rem;
    }
    
    .top-progress {
      font-size: 0.8rem;
      opacity: 0.7;
      margin-top: 0.2rem;
    }
    
    .progress-bar {
      background: rgba(255, 255, 255, 0.1);
      height: 3px;
    }
    
    .progress-fill {
      background: #3b82f6;
      height: 100%;
      transition: width 0.3s;
    }
    
    .exercise-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      color: white;
    }
    
    .exercise-header {
      margin-bottom: 1rem;
    }
    
    .type-badge {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .type-macchina { background: #3b82f6; }
    .type-pesi { background: #10b981; }
    .type-cavi { background: #8b5cf6; }
    .type-corpo_libero { background: #f59e0b; }
    .type-cardio { background: #ef4444; }
    
    .day-label {
      float: right;
      font-size: 0.9rem;
      opacity: 0.6;
    }
    
    .exercise-name {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    
    .machine-name {
      font-size: 0.9rem;
      opacity: 0.6;
      margin-bottom: 1rem;
    }
    
    .exercise-image {
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
      position: relative;
      cursor: pointer;
    }
    
    .exercise-image:active {
      opacity: 0.8;
    }
    
    .exercise-image img {
      width: 100%;
      height: 200px;
      object-fit: contain;
    }
    
    .photo-overlay {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(59, 130, 246, 0.9);
      color: white;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .info-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      padding-top: 3rem;
      margin-bottom: 1rem;
      position: relative;
    }
    
    .edit-exercise-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(59, 130, 246, 0.8);
      border: none;
      border-radius: 0.5rem;
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: bold;
    }
    
    .info-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-item label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      opacity: 0.6;
      margin-bottom: 0.3rem;
    }
    
    .info-item value {
      display: block;
      font-size: 1.2rem;
      font-weight: bold;
    }
    
    .carico-section {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 1rem;
    }
    
    .carico-main {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .carico-peso {
      font-size: 2.5rem;
      font-weight: bold;
      color: #3b82f6;
    }
    
    .carico-unit {
      font-size: 1rem;
      opacity: 0.6;
    }
    
    .serie-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .serie-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 0.5rem;
      padding: 0.8rem;
      text-align: center;
    }
    
    .serie-label {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-bottom: 0.3rem;
    }
    
    .serie-reps {
      font-size: 1.3rem;
      font-weight: bold;
    }
    
    .serie-unit {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-top: 0.2rem;
    }
    
    .notes-box {
      background: rgba(234, 179, 8, 0.2);
      border: 1px solid rgba(234, 179, 8, 0.5);
      border-radius: 1rem;
      padding: 1rem;
    }
    
    .notes-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: #fbbf24;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .notes-text {
      font-size: 0.9rem;
      color: #fef3c7;
      line-height: 1.5;
    }
    
    .bottom-nav {
      background: rgba(0, 0, 0, 0.3);
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .nav-btn {
      background: #3b82f6;
      border: none;
      border-radius: 50%;
      width: 3.5rem;
      height: 3.5rem;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .nav-btn:active {
      transform: scale(0.9);
    }
    
    .nav-btn:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.3);
      cursor: not-allowed;
    }
    
    .nav-dots {
      display: flex;
      gap: 0.3rem;
      flex: 1;
      justify-content: center;
      padding: 0 1rem;
      overflow-x: auto;
    }
    
    .nav-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      border: none;
      padding: 0;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .nav-dot.active {
      width: 32px;
      border-radius: 4px;
      background: #3b82f6;
    }
    
    .footer-tip {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.85rem;
      margin-top: 1rem;
      line-height: 1.5;
    }
    
    #photoInput {
      display: none;
    }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      max-height: 85vh;
      overflow-y: auto;
      color: white;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      font-size: 1.5rem;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .exercise-list {
      margin-top: 1rem;
    }
    
    .exercise-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .exercise-item-info {
      flex: 1;
    }
    
    .exercise-item-name {
      font-weight: bold;
      margin-bottom: 0.3rem;
    }
    
    .exercise-item-details {
      font-size: 0.85rem;
      opacity: 0.7;
    }
    
    .exercise-item-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .icon-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .icon-btn.delete {
      background: rgba(239, 68, 68, 0.3);
    }
    
    .add-exercise-btn {
      width: 100%;
      padding: 1rem;
      background: rgba(59, 130, 246, 0.3);
      border: 2px dashed rgba(59, 130, 246, 0.5);
      color: white;
      border-radius: 1rem;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<input type="file" id="photoInput" accept="image/*">

<!-- Setup Screen -->
<div class="screen setup-screen" id="setupScreen">
  <div class="setup-box">
    <div class="setup-title">
      <h1>üí™ Benvenuto!</h1>
      <p>Crea il tuo profilo di allenamento</p>
    </div>
    <form id="setupForm" onsubmit="return false;">
      <div class="form-group">
        <label for="userName">Il tuo nome</label>
        <input type="text" id="userName" placeholder="es. Mario Rossi" required>
      </div>
      <div class="form-group">
        <label for="trainerName">Nome del tuo Personal Trainer</label>
        <input type="text" id="trainerName" placeholder="es. Alex Cassoni" required>
      </div>
      <button type="button" class="setup-btn" onclick="saveUserProfile()">Inizia üöÄ</button>
    </form>
  </div>
</div>

<!-- Home Screen -->
<div class="screen home-screen" id="homeScreen">
  <div class="home-title">
    <h1>üí™ Allenamento</h1>
  </div>
  
  <div class="user-badge">
    <div class="user-info">
      <div class="user-name" id="displayUserName">Nome Utente</div>
      <div class="user-trainer" id="displayTrainerName">Personal Trainer</div>
    </div>
    <button class="change-user-btn" onclick="changeUser()">Cambia</button>
  </div>
  
  <div class="day-buttons">
    <button class="day-btn" onclick="selectDay('A')">
      <div class="day-edit-btn" onclick="event.stopPropagation(); editDay('A')">‚úèÔ∏è</div>
      <div class="day-name">Giorno A</div>
      <div class="day-count" id="countA">0 esercizi</div>
    </button>
    <button class="day-btn" onclick="selectDay('B')">
      <div class="day-edit-btn" onclick="event.stopPropagation(); editDay('B')">‚úèÔ∏è</div>
      <div class="day-name">Giorno B</div>
      <div class="day-count" id="countB">0 esercizi</div>
    </button>
    <button class="day-btn" onclick="selectDay('C')">
      <div class="day-edit-btn" onclick="event.stopPropagation(); editDay('C')">‚úèÔ∏è</div>
      <div class="day-name">Giorno C</div>
      <div class="day-count" id="countC">0 esercizi</div>
    </button>
  </div>
  
  <div class="footer-tip">
    üì∏ Tocca le immagini per aggiungere foto<br>
    ‚úèÔ∏è Modifica per personalizzare gli esercizi
  </div>
</div>

<!-- Exercise Screen -->
<div class="screen exercise-screen" id="exerciseScreen">
  <div class="top-bar">
    <button class="home-btn" onclick="goHome()">üè†</button>
    <div class="top-info">
      <div class="top-day" id="topDay">Giorno A</div>
      <div class="top-progress" id="topProgress">Esercizio 1 di 9</div>
    </div>
    <div style="width: 2.5rem;"></div>
  </div>
  
  <div class="progress-bar">
    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
  </div>
  
  <div class="exercise-content" id="exerciseContent"></div>
  
  <div class="bottom-nav">
    <button class="nav-btn" id="prevBtn" onclick="prevExercise()">‚Äπ</button>
    <div class="nav-dots" id="navDots"></div>
    <button class="nav-btn" id="nextBtn" onclick="nextExercise()">‚Ä∫</button>
  </div>
</div>

<!-- Edit Day Modal -->
<div class="modal-overlay" id="editDayModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="editDayTitle">Modifica Giorno A</div>
      <button class="modal-close" onclick="closeEditDayModal()">√ó</button>
    </div>
    <div class="exercise-list" id="exerciseList"></div>
    <button class="add-exercise-btn" onclick="addNewExercise()">+ Aggiungi Esercizio</button>
  </div>
</div>

<!-- Edit Exercise Modal -->
<div class="modal-overlay" id="editExerciseModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Modifica Esercizio</div>
      <button class="modal-close" onclick="closeEditExerciseModal()">√ó</button>
    </div>
    <form id="editExerciseForm" onsubmit="return false;">
      <div class="form-group">
        <label>Nome esercizio</label>
        <select id="editExNameSelect" onchange="handleExerciseSelect()">
          <option value="">-- Scegli esercizio --</option>
          <option value="__custom__">‚úèÔ∏è Scrivi manualmente</option>
        </select>
        <input type="text" id="editExName" style="display: none; margin-top: 0.5rem;" placeholder="Nome esercizio personalizzato">
      </div>
      <div class="form-group">
        <label>Tipo</label>
        <select id="editExTipo">
          <option value="macchina">Macchina</option>
          <option value="pesi">Pesi Liberi</option>
          <option value="cavi">Cavi</option>
          <option value="corpo_libero">Corpo Libero</option>
          <option value="cardio">Cardio</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nome macchina/attrezzatura</label>
        <input type="text" id="editExMacchina" readonly style="opacity: 0.7;">
        <small style="display: block; margin-top: 0.3rem; font-size: 0.75rem; opacity: 0.6;">Auto-compilato dalla scelta esercizio</small>
      </div>
      <div class="form-group">
        <label>Serie x Ripetizioni (es. 3 x 8/10)</label>
        <input type="text" id="editExSerie" required>
      </div>
      <div class="form-group">
        <label>Carico (es. 25(10-10-9) oppure 10/12,5)</label>
        <input type="text" id="editExCarico" required>
      </div>
      <div class="form-group">
        <label>Recupero (es. 2" oppure 1'30")</label>
        <input type="text" id="editExRecupero" required>
      </div>
      <div class="form-group">
        <label>Note tecniche</label>
        <textarea id="editExNote" rows="3"></textarea>
      </div>
      <button class="primary-btn" onclick="saveEditedExercise()">Salva Modifiche</button>
      <button class="secondary-btn danger-btn" onclick="deleteExercise()" style="margin-top: 1rem;">Elimina Esercizio</button>
    </form>
  </div>
</div>

<script>
// Default workout data (template)
const defaultWorkoutData = {
  A: [
    { nome: "Chest Press Convergente", serie: "3 x 8/10", recupero: "3\"", note: "Discesa lenta e controllata, gomiti in linea, spalle basse", carico: "25(10-10-9)", tipo: "macchina", macchina: "Chest Press Convergente Technogym" },
    { nome: "Lat Machine con Triangolo", serie: "3 x 7/9", recupero: "2\"", note: "Avambraccio perpendicolare al terreno", carico: "40(9-10-10)", tipo: "macchina", macchina: "Lat Machine Technogym" },
    { nome: "Leg Press Orizzontale", serie: "3 x 8/10", recupero: "3\"", note: "Max profondit√†, 1 sec di fermo in buca", carico: "70(10-10-10)", tipo: "macchina", macchina: "Leg Press Horizontal Technogym" },
    { nome: "Lento Avanti con Manubri", serie: "2 x 6/9", recupero: "2\"", note: "Gomiti avanti e perpendicolari al terreno, max allungamento", carico: "6(10) 8(9)", tipo: "pesi", macchina: "Manubri" },
    { nome: "Curl con Corda Cavo Basso", serie: "2 x 8/10", recupero: "2\"", note: "Gomiti fissi, 1 sec di contrazione di picco", carico: "12,5(10-10)", tipo: "cavi", macchina: "Cable Station Technogym" },
    { nome: "French Press con Manubri", serie: "2 x 8/10", recupero: "2\"", note: "Panca piana, gomiti fermi, manubrio che arriva vicino alle orecchie", carico: "4(10-10)", tipo: "pesi", macchina: "Manubri + Panca" },
    { nome: "Plank", serie: "3 x 1'", recupero: "1\"", note: "Mantenere schiena dritta", carico: "Corpo libero", tipo: "corpo_libero" },
    { nome: "Posturale", serie: "5/10 minuti", recupero: "-", note: "Tutto ci√≤ che facciamo assieme", carico: "-", tipo: "corpo_libero" },
    { nome: "Cardio: Tapis Inclinato", serie: "20 minuti", recupero: "-", note: "Inclinazione minima 7%", carico: "-", tipo: "cardio" }
  ],
  B: [
    { nome: "Step Up", serie: "3 x 8/10", recupero: "2\"", note: "Monopodalico, inizia prima con la gamba debole", carico: "10/12,5", tipo: "pesi", macchina: "Manubri + Step" },
    { nome: "Adductor Machine", serie: "2 x 10/12", recupero: "1'30\"", note: "", carico: "20", tipo: "macchina", macchina: "Adductor Technogym" },
    { nome: "Chest Press Incline", serie: "2 x 8/10", recupero: "2\"", note: "Scapole depresse, max allungamento", carico: "20", tipo: "macchina", macchina: "Incline Chest Press Technogym" },
    { nome: "Pec Fly", serie: "2 x 8/10", recupero: "2\"", note: "Braccia semitese, allungamento max", carico: "10/12,5", tipo: "macchina", macchina: "Pec Fly Technogym" },
    { nome: "Pulley", serie: "3 x 8/10", recupero: "2\"", note: "Adduzione scapolare completa", carico: "30", tipo: "macchina", macchina: "Low Row Technogym" },
    { nome: "Alzate Laterali Manubri", serie: "3 x 10/12", recupero: "2\"", note: "Panca 75 gradi, braccia tese, segui il piano scapolare", carico: "5", tipo: "pesi", macchina: "Manubri + Panca" },
    { nome: "Superset: Faceaway Curl + Push Down", serie: "2 x 10+10", recupero: "2\"", note: "Superset", carico: "12,5 + 10", tipo: "cavi", macchina: "Cable Station Technogym" },
    { nome: "Crunch con Disco", serie: "3 x 12/15", recupero: "1\"", note: "Non piegare troppo il collo", carico: "10", tipo: "corpo_libero" },
    { nome: "Posturale", serie: "5/10 minuti", recupero: "-", note: "Tutto ci√≤ che facciamo assieme", carico: "-", tipo: "corpo_libero" },
    { nome: "Cardio: Bicicletta", serie: "20 minuti", recupero: "-", note: "", carico: "-", tipo: "cardio" }
  ],
  C: [
    { nome: "Spinte con Manubri su Panca Inclinata", serie: "3 x 6/9", recupero: "3\"", note: "Gomiti e polsi a 45 gradi, max allungamento", carico: "9(9-9-9)", tipo: "pesi", macchina: "Manubri + Panca Inclinata" },
    { nome: "Vertical Traction", serie: "2 x 7/9", recupero: "2\"", note: "Avambraccio perpendicolare al terreno", carico: "35(12) 40(9)", tipo: "macchina", macchina: "Lat Machine Technogym" },
    { nome: "Low Row", serie: "2 x 7/9", recupero: "2\"", note: "Adduzione scapolare", carico: "35(10) 45(10)", tipo: "macchina", macchina: "Low Row Technogym" },
    { nome: "Superset: Leg Extension + Leg Curl", serie: "2 x 8/10 + 8/10", recupero: "2\"", note: "Superset", carico: "27,5(12-12)", tipo: "macchina", macchina: "Leg Extension + Leg Curl Technogym" },
    { nome: "Shoulder Press", serie: "2 x 6/9", recupero: "2\"", note: "Gomiti in linea di spinta, bilanciere che arriva sopra la testa", carico: "15(10-7)", tipo: "macchina", macchina: "Shoulder Press Technogym" },
    { nome: "Superset: Curl su Panca 45 + Push Down", serie: "3 x 10+10", recupero: "2\"", note: "Superset", carico: "7(10-10) 15(12-12)", tipo: "cavi", macchina: "Cable Station + Panca" },
    { nome: "Plank", serie: "3 x 1'", recupero: "1\"", note: "Mantenere schiena dritta", carico: "Corpo libero", tipo: "corpo_libero" },
    { nome: "Posturale", serie: "5/10 minuti", recupero: "-", note: "Tutto ci√≤ che facciamo assieme", carico: "-", tipo: "corpo_libero" },
    { nome: "Cardio: Tapis Inclinato", serie: "20 minuti", recupero: "-", note: "Inclinazione minima 7%", carico: "-", tipo: "cardio" }
  ]
};

let currentUser = null;
let currentDay = null;
let currentExercise = 0;
let currentPhotoExerciseId = null;
let editingDay = null;
let editingExerciseIndex = null;

// User management
function getCurrentUser() {
  return localStorage.getItem('current_user');
}

function setCurrentUser(username) {
  localStorage.setItem('current_user', username);
  currentUser = username;
}

function getUserData(username, key) {
  const data = localStorage.getItem(`user_${username}_${key}`);
  return data ? JSON.parse(data) : null;
}

function setUserData(username, key, value) {
  localStorage.setItem(`user_${username}_${key}`, JSON.stringify(value));
}

function getWorkoutData(username) {
  const data = getUserData(username, 'workout');
  return data || JSON.parse(JSON.stringify(defaultWorkoutData)); // Deep copy of default
}

function saveWorkoutData(username, data) {
  setUserData(username, 'workout', data);
}

function saveUserProfile() {
  const userName = document.getElementById('userName').value.trim();
  const trainerName = document.getElementById('trainerName').value.trim();
  
  if (!userName || !trainerName) {
    alert('Compila entrambi i campi!');
    return;
  }
  
  setCurrentUser(userName);
  setUserData(userName, 'trainer', trainerName);
  
  // Initialize workout data if not exists
  if (!getUserData(userName, 'workout')) {
    saveWorkoutData(userName, defaultWorkoutData);
  }
  
  showHomeScreen();
}

function changeUser() {
  if (confirm('Vuoi cambiare utente? Potrai tornare al tuo profilo in qualsiasi momento.')) {
    document.getElementById('userName').value = '';
    document.getElementById('trainerName').value = '';
    document.getElementById('homeScreen').classList.remove('active');
    document.getElementById('setupScreen').classList.add('active');
  }
}

function showHomeScreen() {
  const user = getCurrentUser();
  const trainer = getUserData(user, 'trainer');
  
  document.getElementById('displayUserName').textContent = user;
  document.getElementById('displayTrainerName').textContent = `PT: ${trainer}`;
  
  // Update exercise counts
  const workout = getWorkoutData(user);
  document.getElementById('countA').textContent = `${workout.A.length} esercizi`;
  document.getElementById('countB').textContent = `${workout.B.length} esercizi`;
  document.getElementById('countC').textContent = `${workout.C.length} esercizi`;
  
  document.getElementById('setupScreen').classList.remove('active');
  document.getElementById('homeScreen').classList.add('active');
}

// Photo management (per user per exercise)
function getPhotoKey(exerciseIndex) {
  return `photo_${currentUser}_${currentDay}_${exerciseIndex}`;
}

function savePhoto(exerciseIndex, photoData) {
  localStorage.setItem(getPhotoKey(exerciseIndex), photoData);
}

function getPhoto(exerciseIndex) {
  return localStorage.getItem(getPhotoKey(exerciseIndex));
}

function handlePhotoClick(exerciseIndex) {
  currentPhotoExerciseId = exerciseIndex;
  document.getElementById('photoInput').click();
}

document.getElementById('photoInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file && currentPhotoExerciseId !== null) {
    const reader = new FileReader();
    reader.onload = function(event) {
      savePhoto(currentPhotoExerciseId, event.target.result);
      updateExerciseScreen();
    };
    reader.readAsDataURL(file);
  }
  e.target.value = '';
});

// Edit Day functionality
function populateExerciseSelect() {
  const select = document.getElementById('editExNameSelect');
  const allExercises = [];
  
  // Collect all unique exercises from default data
  Object.keys(defaultWorkoutData).forEach(day => {
    defaultWorkoutData[day].forEach(ex => {
      if (!allExercises.find(e => e.nome === ex.nome)) {
        allExercises.push(ex);
      }
    });
  });
  
  // Sort alphabetically
  allExercises.sort((a, b) => a.nome.localeCompare(b.nome));
  
  // Keep first two options, add exercises
  const currentOptions = select.innerHTML;
  const exerciseOptions = allExercises.map(ex => 
    `<option value="${encodeURIComponent(JSON.stringify(ex))}">${ex.nome}</option>`
  ).join('');
  
  select.innerHTML = currentOptions.split('</option>').slice(0, 2).join('</option>') + '</option>' + exerciseOptions;
}

function handleExerciseSelect() {
  const select = document.getElementById('editExNameSelect');
  const customInput = document.getElementById('editExName');
  const machineInput = document.getElementById('editExMacchina');
  
  if (select.value === '__custom__') {
    // Show custom input
    customInput.style.display = 'block';
    customInput.required = true;
    customInput.value = '';
    machineInput.value = '';
    machineInput.removeAttribute('readonly');
    machineInput.style.opacity = '1';
  } else if (select.value === '') {
    // Nothing selected
    customInput.style.display = 'none';
    customInput.required = false;
    machineInput.value = '';
  } else {
    // Exercise selected from default
    customInput.style.display = 'none';
    customInput.required = false;
    
    try {
      const exercise = JSON.parse(decodeURIComponent(select.value));
      customInput.value = exercise.nome;
      
      // Auto-fill fields
      document.getElementById('editExTipo').value = exercise.tipo;
      machineInput.value = exercise.macchina || '';
      machineInput.setAttribute('readonly', true);
      machineInput.style.opacity = '0.7';
      document.getElementById('editExSerie').value = exercise.serie;
      document.getElementById('editExCarico').value = exercise.carico;
      document.getElementById('editExRecupero').value = exercise.recupero;
      document.getElementById('editExNote').value = exercise.note || '';
    } catch (e) {
      console.error('Error parsing exercise data', e);
    }
  }
}

function editDay(day) {
  editingDay = day;
  const workout = getWorkoutData(currentUser);
  const exercises = workout[day];
  
  document.getElementById('editDayTitle').textContent = `Modifica Giorno ${day}`;
  
  const listHtml = exercises.map((ex, idx) => `
    <div class="exercise-item">
      <div class="exercise-item-info">
        <div class="exercise-item-name">${ex.nome}</div>
        <div class="exercise-item-details">${ex.serie} ‚Ä¢ ${ex.carico} kg</div>
      </div>
      <div class="exercise-item-actions">
        <button class="icon-btn" onclick="editExercise(${idx})">‚úèÔ∏è</button>
        <button class="icon-btn delete" onclick="confirmDeleteExercise(${idx})">üóëÔ∏è</button>
      </div>
    </div>
  `).join('');
  
  document.getElementById('exerciseList').innerHTML = listHtml;
  document.getElementById('editDayModal').classList.add('active');
}

function closeEditDayModal() {
  document.getElementById('editDayModal').classList.remove('active');
  editingDay = null;
  showHomeScreen(); // Refresh counts
}

function addNewExercise() {
  editingExerciseIndex = -1; // -1 means new exercise
  
  // Populate exercise select
  populateExerciseSelect();
  
  // Clear form
  document.getElementById('editExNameSelect').value = '';
  document.getElementById('editExName').value = '';
  document.getElementById('editExName').style.display = 'none';
  document.getElementById('editExName').required = false;
  document.getElementById('editExTipo').value = 'macchina';
  document.getElementById('editExMacchina').value = '';
  document.getElementById('editExMacchina').setAttribute('readonly', true);
  document.getElementById('editExMacchina').style.opacity = '0.7';
  document.getElementById('editExSerie').value = '';
  document.getElementById('editExCarico').value = '';
  document.getElementById('editExRecupero').value = '';
  document.getElementById('editExNote').value = '';
  
  document.getElementById('editDayModal').classList.remove('active');
  document.getElementById('editExerciseModal').classList.add('active');
}

function editExercise(index) {
  editingExerciseIndex = index;
  const workout = getWorkoutData(currentUser);
  const ex = workout[editingDay][index];
  
  // Populate exercise select
  populateExerciseSelect();
  
  // Try to find exercise in default list
  let foundInDefaults = false;
  const select = document.getElementById('editExNameSelect');
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value && select.options[i].value !== '__custom__') {
      try {
        const optionEx = JSON.parse(decodeURIComponent(select.options[i].value));
        if (optionEx.nome === ex.nome) {
          select.value = select.options[i].value;
          foundInDefaults = true;
          break;
        }
      } catch (e) {}
    }
  }
  
  if (!foundInDefaults) {
    // Custom exercise, use manual input
    select.value = '__custom__';
    document.getElementById('editExName').style.display = 'block';
    document.getElementById('editExName').required = true;
    document.getElementById('editExMacchina').removeAttribute('readonly');
    document.getElementById('editExMacchina').style.opacity = '1';
  }
  
  // Fill form
  document.getElementById('editExName').value = ex.nome;
  document.getElementById('editExTipo').value = ex.tipo;
  document.getElementById('editExMacchina').value = ex.macchina || '';
  document.getElementById('editExSerie').value = ex.serie;
  document.getElementById('editExCarico').value = ex.carico;
  document.getElementById('editExRecupero').value = ex.recupero;
  document.getElementById('editExNote').value = ex.note || '';
  
  document.getElementById('editDayModal').classList.remove('active');
  document.getElementById('editExerciseModal').classList.add('active');
}

function saveEditedExercise() {
  // Get name from select or custom input
  const select = document.getElementById('editExNameSelect');
  let nomeEsercizio = '';
  
  if (select.value === '__custom__' || select.value === '') {
    nomeEsercizio = document.getElementById('editExName').value.trim();
  } else {
    nomeEsercizio = document.getElementById('editExName').value.trim();
  }
  
  const newEx = {
    nome: nomeEsercizio,
    tipo: document.getElementById('editExTipo').value,
    macchina: document.getElementById('editExMacchina').value.trim(),
    serie: document.getElementById('editExSerie').value.trim(),
    carico: document.getElementById('editExCarico').value.trim(),
    recupero: document.getElementById('editExRecupero').value.trim(),
    note: document.getElementById('editExNote').value.trim()
  };
  
  if (!newEx.nome || !newEx.serie || !newEx.carico || !newEx.recupero) {
    alert('Compila tutti i campi obbligatori!');
    return;
  }
  
  const workout = getWorkoutData(currentUser);
  
  if (editingExerciseIndex === -1) {
    // New exercise
    workout[editingDay].push(newEx);
  } else {
    // Update existing
    workout[editingDay][editingExerciseIndex] = newEx;
  }
  
  saveWorkoutData(currentUser, workout);
  
  // Close modal and navigate back
  closeEditExerciseModal();
  
  // If we came from day edit modal, refresh it
  if (document.getElementById('editDayModal').classList.contains('active')) {
    editDay(editingDay);
  }
}

function deleteExercise() {
  if (editingExerciseIndex === -1) return;
  
  if (confirm('Sei sicuro di voler eliminare questo esercizio?')) {
    const workout = getWorkoutData(currentUser);
    workout[editingDay].splice(editingExerciseIndex, 1);
    saveWorkoutData(currentUser, workout);
    closeEditExerciseModal();
    editDay(editingDay); // Refresh list
  }
}

function confirmDeleteExercise(index) {
  editingExerciseIndex = index;
  if (confirm('Sei sicuro di voler eliminare questo esercizio?')) {
    const workout = getWorkoutData(currentUser);
    workout[editingDay].splice(index, 1);
    saveWorkoutData(currentUser, workout);
    editDay(editingDay); // Refresh list
  }
}

function closeEditExerciseModal() {
  document.getElementById('editExerciseModal').classList.remove('active');
  document.getElementById('editDayModal').classList.add('active');
}

// Exercise navigation
function selectDay(day) {
  currentDay = day;
  currentExercise = 0;
  document.getElementById('homeScreen').classList.remove('active');
  document.getElementById('exerciseScreen').classList.add('active');
  updateExerciseScreen();
}

function goHome() {
  document.getElementById('exerciseScreen').classList.remove('active');
  document.getElementById('homeScreen').classList.add('active');
  currentDay = null;
  currentExercise = 0;
}

function prevExercise() {
  const workout = getWorkoutData(currentUser);
  if (currentExercise > 0) {
    currentExercise--;
    updateExerciseScreen();
  }
}

function nextExercise() {
  const workout = getWorkoutData(currentUser);
  const exercises = workout[currentDay];
  if (currentExercise < exercises.length - 1) {
    currentExercise++;
    updateExerciseScreen();
  }
}

function jumpToExercise(index) {
  currentExercise = index;
  updateExerciseScreen();
}

function parseCarico(carico) {
  if (carico === "Corpo libero" || carico === "-") {
    return { peso: null, serie: [] };
  }
  
  const match = carico.match(/^([\d,\.]+)\((.+)\)$/);
  if (match) {
    const peso = match[1];
    const reps = match[2].split('-').map(r => r.trim());
    return { peso, serie: reps };
  }
  
  return { peso: carico, serie: [] };
}

function getTypeLabel(tipo) {
  const labels = {
    macchina: 'Macchina',
    pesi: 'Pesi Liberi',
    cavi: 'Cavi',
    corpo_libero: 'Corpo Libero',
    cardio: 'Cardio'
  };
  return labels[tipo] || '';
}

function updateExerciseScreen() {
  const workout = getWorkoutData(currentUser);
  const exercises = workout[currentDay];
  const exercise = exercises[currentExercise];
  const total = exercises.length;
  const progress = ((currentExercise + 1) / total) * 100;
  
  document.getElementById('topDay').textContent = `Giorno ${currentDay}`;
  document.getElementById('topProgress').textContent = `Esercizio ${currentExercise + 1} di ${total}`;
  document.getElementById('progressFill').style.width = `${progress}%`;
  
  document.getElementById('prevBtn').disabled = (currentExercise === 0);
  document.getElementById('nextBtn').disabled = (currentExercise === total - 1);
  
  const dotsHtml = exercises.map((_, idx) => 
    `<button class="nav-dot ${idx === currentExercise ? 'active' : ''}" onclick="jumpToExercise(${idx})"></button>`
  ).join('');
  document.getElementById('navDots').innerHTML = dotsHtml;
  
  const { peso, serie } = parseCarico(exercise.carico);
  
  let html = `
    <div class="exercise-header">
      <span class="type-badge type-${exercise.tipo}">${getTypeLabel(exercise.tipo)}</span>
      <span class="day-label">Giorno ${currentDay}</span>
      <div class="exercise-name">${exercise.nome}</div>
      ${exercise.macchina ? `<div class="machine-name">${exercise.macchina}</div>` : ''}
    </div>
  `;
  
  if (exercise.tipo !== 'corpo_libero' && exercise.tipo !== 'cardio') {
    const savedPhoto = getPhoto(currentExercise);
    const imageUrl = savedPhoto || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect fill='%23e5e7eb' width='200' height='200'/%3E%3Ctext x='50%25' y='45%25' text-anchor='middle' dy='.3em' fill='%239ca3af' font-family='sans-serif' font-size='14'%3ETechnogym%3C/text%3E%3Ctext x='50%25' y='60%25' text-anchor='middle' dy='.3em' fill='%23b0b0b0' font-family='sans-serif' font-size='9'%3E${encodeURIComponent(exercise.nome)}%3C/text%3E%3C/svg%3E`;
    
    html += `
      <div class="exercise-image" onclick="handlePhotoClick(${currentExercise})">
        <img src="${imageUrl}" alt="${exercise.nome}">
        <div class="photo-overlay">üì∑</div>
      </div>
    `;
  }
  
  html += `
    <div class="info-box">
      <button class="edit-exercise-btn" onclick="quickEditExercise()">‚úèÔ∏è Modifica</button>
      <div class="info-row">
        <div class="info-item">
          <label>Serie</label>
          <value>${exercise.serie}</value>
        </div>
        <div class="info-item">
          <label>Recupero</label>
          <value>${exercise.recupero}</value>
        </div>
      </div>
  `;
  
  if (peso && peso !== '-') {
    html += `
      <div class="carico-section">
        <label style="font-size: 0.7rem; text-transform: uppercase; opacity: 0.6; margin-bottom: 0.5rem; display: block;">Carico</label>
        <div class="carico-main">
          <span class="carico-peso">${peso}</span>
          <span class="carico-unit">kg</span>
        </div>
    `;
    
    if (serie.length > 0) {
      html += `<div class="serie-grid">`;
      serie.forEach((reps, idx) => {
        html += `
          <div class="serie-box">
            <div class="serie-label">Serie ${idx + 1}</div>
            <div class="serie-reps">${reps}</div>
            <div class="serie-unit">rip</div>
          </div>
        `;
      });
      html += `</div>`;
    }
    
    html += `</div>`;
  }
  
  html += `</div>`;
  
  if (exercise.note && exercise.note !== '-') {
    html += `
      <div class="notes-box">
        <div class="notes-title">Note Tecniche</div>
        <div class="notes-text">${exercise.note}</div>
      </div>
    `;
  }
  
  document.getElementById('exerciseContent').innerHTML = html;
  document.getElementById('exerciseContent').scrollTop = 0;
}

function quickEditExercise() {
  editingDay = currentDay;
  editingExerciseIndex = currentExercise;
  
  const workout = getWorkoutData(currentUser);
  const ex = workout[currentDay][currentExercise];
  
  // Populate exercise select
  populateExerciseSelect();
  
  // Try to find exercise in default list
  let foundInDefaults = false;
  const select = document.getElementById('editExNameSelect');
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].value && select.options[i].value !== '__custom__') {
      try {
        const optionEx = JSON.parse(decodeURIComponent(select.options[i].value));
        if (optionEx.nome === ex.nome) {
          select.value = select.options[i].value;
          foundInDefaults = true;
          break;
        }
      } catch (e) {}
    }
  }
  
  if (!foundInDefaults) {
    // Custom exercise
    select.value = '__custom__';
    document.getElementById('editExName').style.display = 'block';
    document.getElementById('editExName').required = true;
    document.getElementById('editExMacchina').removeAttribute('readonly');
    document.getElementById('editExMacchina').style.opacity = '1';
  }
  
  document.getElementById('editExName').value = ex.nome;
  document.getElementById('editExTipo').value = ex.tipo;
  document.getElementById('editExMacchina').value = ex.macchina || '';
  document.getElementById('editExSerie').value = ex.serie;
  document.getElementById('editExCarico').value = ex.carico;
  document.getElementById('editExRecupero').value = ex.recupero;
  document.getElementById('editExNote').value = ex.note || '';
  
  document.getElementById('exerciseScreen').classList.remove('active');
  document.getElementById('editExerciseModal').classList.add('active');
}

function closeEditExerciseModal() {
  document.getElementById('editExerciseModal').classList.remove('active');
  
  // Check if we should go back to exercise view or day edit modal
  if (currentDay && currentExercise >= 0) {
    // We were in exercise view
    document.getElementById('exerciseScreen').classList.add('active');
    updateExerciseScreen();
  } else {
    // We were in day edit modal
    document.getElementById('editDayModal').classList.add('active');
  }
}

// Touch swipe support
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', e => {
  touchStartX = e.changedTouches[0].screenX;
}, false);

document.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
}, false);

function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;
  
  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      nextExercise();
    } else {
      prevExercise();
    }
  }
}

// Initialize app
window.addEventListener('DOMContentLoaded', () => {
  const user = getCurrentUser();
  if (user) {
    currentUser = user;
    showHomeScreen();
  } else {
    document.getElementById('setupScreen').classList.add('active');
  }
});
</script>

</body>
</html>
